<div class="statHolder">
    <h4 class="statTitle"><i class="far fa-building"></i> Pool &nbsp;</h4>
    <div style="display:inline-block">
        <div class="dropdown">
            <button class="btn btn-info" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
                <span value="wk" id="poolSelectorText">Last week</span>
                <span class="caret"></span>
            </button>
            <ul class="dropdown-menu" id="poolMenu">
                <li><a href="javascript:void(0)" value="day">Last 24 hours</a></li>
                <li><a href="javascript:void(0)" value="wk">Last week</a></li>
                <li><a href="javascript:void(0)" value="wk2">Last 2 weeks</a></li>
                <li><a href="javascript:void(0)" value="mo">Last month</a></li>
            </ul>
        </div>
    </div>
    <span class="bg-primary">Hash rate: <span id="poolHashrate"></span></span>
    <span class="bg-info">Connected miners: <span id="poolMiners"></span></span>
    <span class="bg-info">Round hashes: <span id="poolRoundHashes"></span></span>
</div>

<hr>
<div id="pool-chart-container" style="height: 180px; min-width: 310px"></div>
<hr>

<div class="statHolder">
    <h4 class="statTitle"><i class="fas fa-globe"></i> Network &nbsp;</h4>
    <div style="display:inline-block">
        <div class="dropdown">
            <button class="btn btn-info" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
                <span value="wk" id="netSelectorText">Last week</span>
                <span class="caret"></span>
            </button>
            <ul class="dropdown-menu" id="netMenu">
                <li><a href="javascript:void(0)" value="day">Last 24 hours</a></li>
                <li><a href="javascript:void(0)" value="wk">Last week</a></li>
                <li><a href="javascript:void(0)" value="wk2">Last 2 weeks</a></li>
                <li><a href="javascript:void(0)" value="mo">Last month</a></li>
            </ul>
        </div>
    </div>
    <span class="bg-primary">Hash rate: <span id="networkHashrate"></span></span>
    <span class="bg-info">Difficulty: <span id="networkDifficulty"></span></span>
    <span class="bg-info">Blockchain height: <span id="blockchainHeight"></span></span>
</div>
    
<hr>
<div id="net-chart-container" style="height: 180px; min-width: 310px"></div>
<hr>

<div class="statHolder">
    <h4 class="statTitle"><i class="fas fa-stopwatch"></i> Round &nbsp;</h4>
    <div style="display:inline-block">
        <div class="dropdown">
            <button class="btn btn-info" type="button" id="roundSelector" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
                <span id="roundSelectorText" value="0">Current round</span>
                <span class="caret"></span>
            </button>
            <ul class="dropdown-menu" id="roundsMenu">
                <li><a href="javascript:void(0)" value="0">Current round</a></li>
                <li role="separator" class="divider"></li>      
            </ul>
        </div>
    </div>
    <span class="bg-primary">Round hashes: <span id="totalRoundHashes"></span></span>
    <span class="bg-info">Round miners: <span id="totalMiners"></span></span>
    <span class="bg-info">Round block reward: <span id="blockReward"></span></span>
</div>

<hr>
    
<div class="table-responsive">
    <table class="table table-hover table-striped">
        <thead>
        <tr>
            <th style="width:30px;"><i class="fas fa-list-ol"></i></th>
            <th><i class="fas fa-address-card"></i> Wallet adddress</th>
            <th style="width:90px;"><i class="fa fa-chart-pie"></i> Hashes</th>
            <th style="width:90px;"><i class="fa fas fa-money-bill-alt"></i> Reward</th>
        </tr>
        </thead>
        <tbody id="stats_rows" class="stats_rows">
        </tbody>
    </table>
</div>

<p class="text-center">
    <button type="button" class="btn btn-default" id="loadMoreStats">Load More</button>
</p>

<script>

var xhrGetRound;
currentPage = {
    destroy: function() {
        if (xhrGetRound) xhrGetRound.abort();
    },
    update: function() {
        updateText('poolHashrate', getReadableHashRateString(lastStats.pool.hashrate) + '/sec');
        updateText('poolMiners', lastStats.pool.miners.toString());
        updateText('poolRoundHashes', lastStats.pool.roundHashes.toString());
		updateText('networkHashrate', getReadableHashRateString(lastStats.network.difficulty / 60) + '/sec');
		updateText('networkDifficulty', lastStats.network.difficulty.toString());
        updateText('blockchainHeight', lastStats.network.height.toString());
        
        if(lastStats.history) {
            if(lastStats.history.historyFrom) {
                updateNetChart(lastStats.history);
                lastTimeNetHistoryRequested = new Date();
            }
            if(lastStats.history.poolHistoryFrom) {
                updatePoolChart(lastStats.history);
                lastTimePoolHistoryRequested = new Date();
            }
        }
    }
};

function updateNetChart(dat) {
}

function updatePoolChart(dat) {
}

function renderRound(data, miner) {

    var roundRows = $('#stats_rows');

    for (var i = 0; i < data.length; i++) {

        var dataJson = JSON.stringify(data[i]);
        var existingRow = document.getElementById('roundRow' + data[i].rank);

        if (existingRow && existingRow.getAttribute('data-json') !== dataJson){
            $(existingRow).replaceWith(getRoundRowElement(data[i], dataJson, miner));
        }
        else if (!existingRow){

            var roundElement = getRoundRowElement(data[i], dataJson, miner);

            var inserted = false;
            var rows = roundRows.children().get();
            for (var f = 0; f < rows.length; f++) {
                var pRank = parseInt(rows[f].getAttribute('data-rank'));
                if (pRank < roundElement.rank){
                    inserted = true;
                    $(rows[f]).before(roundElement);
                    break;
                }
            }
            if (!inserted)
                roundRows.append(roundElement);
        }
    }
}

function getRoundRowElement(roundShare, jsonString, miner){

    var row = document.createElement('tr'),
        worker = roundShare.address;
    row.setAttribute('data-json', jsonString);
    row.setAttribute('data-rank', roundShare.rank);
    row.setAttribute('id', 'roundRow' + roundShare.rank);

    if(roundShare.address === miner) {
        worker += ' <b>(winner)</b>';
    }

    row.innerHTML = '<td>' + roundShare.rank + '</td>' +
            '<td style="text-align:left;"><a href="/?miner=' + roundShare.address + '">' + worker + '</a></td>' +
            '<td style="text-align:left;">' + roundShare.hashes + '</td>' +
            '<td style="text-align:left;">' + getReadableCoins(roundShare.reward, coinDecimalPlaces, true) + '</td>';

    return row;
}

function loadRound() {
    if (xhrGetRound) xhrGetRound.abort();
    xhrGetRound = $.ajax({
        url: api + '/get_round',
        data: {
            height: $("#roundSelectorText").attr("value"),
            rank: $('#stats_rows').children().last().data('rank')
        },
        dataType: 'json',
        cache: 'false',
        success: function(data){
            data.hashes.forEach(function(itm) {
                itm.reward = itm.hashes / data.roundHashes * data.reward;
            });
            renderRound(data.hashes, data.miner);
            updateText('totalRoundHashes', data.roundHashes.toString());
            updateText('totalMiners', data.roundMinders.toString());
            updateText('blockReward', getReadableCoins(data.reward, coinDecimalPlaces));
        }
    });
}

$('#loadMoreStats').click(loadRound);

function dropDownSelectorCommon(ddMenu, ddText, selectCb) {
    ddMenu.click(function(){
        var that = $(this), val = that.attr("value"),
            button = ddText, before = button.attr("value");   
        button.text(that.text());
        button.attr("value", val);

        if(before === val) {
            return;
        }
        selectCb();
    });
}

function attachRoundSelector() {
    dropDownSelectorCommon($("#roundsMenu li a"), $("#roundSelectorText"), function() {
        $('#stats_rows').html('');
        loadRound();
    });
}

function populateRounds() {
    if(lastStats.pool.blocks && lastStats.pool.blocks.length) {

        var mnu = $('#roundsMenu'), blks = lastStats.pool.blocks;
        for(var i=0; i < lastStats.pool.blocks.length; i+=2) {
            var blk = blks[i].split(':');
            mnu.append('<li><a href="javascript:void(0)" value="' + blks[i+1] + '">' + blks[i+1] + ' - ' + 
                new Date(parseInt(blk[1]) * 1000).toLocaleString() + '</a></li>');
        }
        mnu.dropdown();
        attachRoundSelector();
    }
}

populateRounds();
loadRound();
attachRoundSelector();

lastTimePoolHistoryRequested = new Date(2018, 1, 1);
lastTimeNetHistoryRequested = new Date(2018, 1, 1);
window.statsUrlExtra = function() {
    var shouldPool = shouldFetchTheHistory(lastTimePoolHistoryRequested),
        shouldNet = shouldFetchTheHistory(lastTimeNetHistoryRequested);
    
    if(!shouldPool && !shouldNet) {
        return '';
    }

    function selectorToDates(val) {
        var to = new Date(), from = new Date(to.getTime());
        switch(val) {
            case 'day':
                from.setDate(from.getDate()-1);
                break;
            case 'wk':
                from.setDate(from.getDate()-7);
                break;
            case 'wk2':
                from.setDate(from.getDate()-14);
                break;
            case 'mo':
                from.setMonth(from.getMonth()-1);
                break;
        }
        return [from, to];
    }

    var netFromTo = selectorToDates($('#netSelectorText').attr('value')), 
        poolFromTo = selectorToDates($('#poolSelectorText').attr('value'));
    


    return '?' + formatFromToDate(netFromTo[0], netFromTo[1], 'historyFrom', 'historyTo') + 
        '&' + formatFromToDate(poolFromTo[0], poolFromTo[1], 'poolHistoryFrom', 'poolHistoryTo');
}

dropDownSelectorCommon($("#poolMenu li a"), $("#poolSelectorText"), function() {

});

dropDownSelectorCommon($("#netMenu li a"), $("#netSelectorText"), function() {
});

// ****************************** Chart **************************
minerChart = null;
function renderMinerChart(data) {
	lastMinerChartUpdate = new Date();
	if(minerChart) {
		var cntr = 0;
		data.forEach(function(itm) {
			minerChart.series[cntr].setData(data[cntr].data, true);			
			cntr++;
		});
		return;
	}
	minerChart = Highcharts.stockChart('chart-container', {
		rangeSelector: { enabled: false },
		scrollbar: { enabled: false },
		navigator: { enabled: false },
		exporting: { enabled: false },
		yAxis: {
			title: {
				text: 'Hash rate (kH/s)'
			},
			labels: {
				formatter: function () {
					return this.value;
				}
			}
		},
		tooltip: {
			pointFormat: '<span style="color:{series.color}">{series.name}</span>: <b>{point.y}</b> (kH/s)<br/>',
			valueDecimals: 2,
			split: true
		},
		series: data
	});
}

</script>